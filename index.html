<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œä»»å‹™è¿½è¹¤å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        
        .task-card { 
            transition: all 0.2s ease-in-out; 
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.45);
            transform: translateY(-1px);
        }
        
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        
        .tab-active { 
            color: #4338ca; 
            background-color: #eef2ff;
            border-bottom: 2px solid #4338ca;
        }
        
        .sortable-ghost {
            opacity: 0.4;
            background: #eef2ff;
            border: 2px dashed #6366f1;
        }
        
        .priority-badge-ç·Šæ€¥ { background-color: #fef2f2; color: #b91c1c; }
        .priority-badge-é«˜ { background-color: #fff7ed; color: #c2410c; }
        .priority-badge-ä¸­ { background-color: #eff6ff; color: #1d4ed8; }
        .priority-badge-ä½ { background-color: #f5f3ff; color: #6d28d9; }
        
        .sort-btn.sort-active { 
            background-color: white; 
            color: #4f46e5; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        
        .custom-input {
            background-color: #f0fdf4 !important;
            border-color: #a7f3d0 !important;
        }
        .custom-input:focus {
            --tw-ring-color: #34d399 !important;
            border-color: #10b981 !important;
        }
        
        .loading-spinner {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .task-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .task-card.expanded .task-details {
            max-height: 300px;
        }
        
        .expand-arrow {
            transition: transform 0.3s ease;
        }
        .task-card.expanded .expand-arrow {
            transform: rotate(180deg);
        }
        
        .department-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-å¾…è¾¦äº‹é … { background-color: #f59e0b; }
        .status-é€²è¡Œä¸­ { background-color: #3b82f6; }
        .status-å·²å®Œæˆ { background-color: #10b981; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8 fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl mx-auto mb-4 flex items-center justify-center">
                    <i class="fas fa-tasks text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900 mb-2">å·¥ä½œä»»å‹™è¿½è¹¤å¹³å°</h1>
                <p class="text-slate-600">è«‹é¸æ“‡æ‚¨çš„èº«ä»½é–‹å§‹ä½¿ç”¨</p>
            </div>

            <!-- User List -->
            <div id="user-list" class="space-y-3 mb-6">
                <!-- å‹•æ…‹è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨ -->
            </div>

            <!-- Add User Button -->
            <button id="add-user-btn" type="button" class="w-full flex items-center justify-center px-4 py-3 text-sm font-semibold text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg transition border border-indigo-200 hover:border-indigo-300">
                <i class="fas fa-plus mr-2"></i>
                æ–°å¢ä½¿ç”¨è€…
            </button>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 fade-in">
            <h2 class="text-xl font-semibold mb-6 text-slate-800">æ–°å¢ä½¿ç”¨è€…</h2>
            
            <form id="add-user-form" class="space-y-4">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="new-user-name" class="block text-sm font-medium text-slate-700 mb-1">å§“å</label>
                        <input type="text" id="new-user-name" name="name" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="è«‹è¼¸å…¥å§“å">
                    </div>
                    
                    <div>
                        <label for="new-user-department" class="block text-sm font-medium text-slate-700 mb-1">éƒ¨é–€</label>
                        <select id="new-user-department" name="department" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="new-user-role" class="block text-sm font-medium text-slate-700 mb-1">è§’è‰²</label>
                        <select id="new-user-role" name="role" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="user">ä¸€èˆ¬ä½¿ç”¨è€…</option>
                            <option value="manager">ç®¡ç†è€…</option>
                            <option value="admin">ç³»çµ±ç®¡ç†å“¡</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-add-user" class="px-4 py-2 text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 transition">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">æ–°å¢</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
            <!-- Header -->
            <header class="text-center mb-8">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 tracking-tight">å·¥ä½œä»»å‹™è¿½è¹¤å¹³å°</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-slate-600">æ‚¨å¥½ï¼Œ<span id="current-user-name" class="font-semibold text-indigo-600"></span></span>
                        <button id="logout-btn" class="text-sm font-medium text-slate-500 hover:text-indigo-600 transition p-2 rounded-md" title="ç™»å‡º">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- View Switcher -->
                <div class="flex justify-center items-center space-x-4 mb-6">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-slate-700">æª¢è¦–æ¨¡å¼:</label>
                        <select id="view-switcher" class="px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                            <option value="my">æˆ‘çš„ä»»å‹™</option>
                            <option value="department">éƒ¨é–€ä»»å‹™</option>
                            <option value="all">å…¨éƒ¨ä»»å‹™</option>
                        </select>
                    </div>
                    
                    <!-- Search and Sort Controls -->
                    <div class="flex items-center space-x-2">
                        <input type="text" id="search-input" placeholder="æœå°‹ä»»å‹™..." class="px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 w-48">
                        
                        <div class="flex items-center space-x-1 bg-slate-100 rounded-lg p-1">
                            <button id="sort-priority" class="sort-btn px-2 py-1 text-xs rounded transition sort-active" data-sort="priority">å„ªå…ˆåº¦</button>
                            <button id="sort-date" class="sort-btn px-2 py-1 text-xs rounded transition" data-sort="date">æ—¥æœŸ</button>
                            <button id="sort-title" class="sort-btn px-2 py-1 text-xs rounded transition" data-sort="title">æ¨™é¡Œ</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Add Task Form -->
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-200 mb-8">
                <h2 class="text-xl font-semibold mb-6 text-slate-800 flex items-center">
                    <i class="fas fa-plus-circle mr-2 text-indigo-600"></i>
                    æ–°å¢ä»»å‹™
                </h2>
                
                <form id="add-task-form" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="task-priority" class="block text-sm font-medium text-slate-600 mb-2">å„ªå…ˆåº¦</label>
                            <select id="task-priority" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="ç·Šæ€¥">ğŸ”´ ç·Šæ€¥</option>
                                <option value="é«˜">ğŸŸ¡ é«˜</option>
                                <option value="ä¸­" selected>ğŸ”µ ä¸­</option>
                                <option value="ä½">âšª ä½</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="task-assignee" class="block text-sm font-medium text-slate-600 mb-2">è² è²¬äºº</label>
                            <input type="text" id="task-assignee" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="è«‹è¼¸å…¥è² è²¬äºº">
                        </div>
                        
                        <div>
                            <label for="task-due-date" class="block text-sm font-medium text-slate-600 mb-2">æˆªæ­¢æ—¥æœŸ</label>
                            <input type="date" id="task-due-date" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <div>
                        <label for="task-department" class="block text-sm font-medium text-slate-600 mb-2">éƒ¨é–€</label>
                        <select id="task-department" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="task-title" class="block text-sm font-medium text-slate-600 mb-2">ä»»å‹™æ¨™é¡Œ</label>
                        <input type="text" id="task-title" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="è«‹è¼¸å…¥ä»»å‹™æ¨™é¡Œ">
                    </div>
                    
                    <div>
                        <label for="task-description" class="block text-sm font-medium text-slate-600 mb-2">ä»»å‹™æè¿°</label>
                        <textarea id="task-description" rows="3" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="è«‹è¼¸å…¥ä»»å‹™æè¿°ï¼ˆå¯é¸ï¼‰"></textarea>
                    </div>
                    
                    <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        <i class="fas fa-plus mr-2"></i>
                        æ–°å¢ä»»å‹™
                    </button>
                </form>
            </div>

            <!-- Department Tabs -->
            <div class="mb-6">
                <div class="border-b border-slate-200">
                    <nav id="department-tabs" class="-mb-px flex space-x-8 overflow-x-auto" aria-label="éƒ¨é–€åˆ†é ">
                        <!-- å‹•æ…‹è¼‰å…¥éƒ¨é–€åˆ†é  -->
                    </nav>
                </div>
            </div>

            <!-- Tasks Container -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Todo Column -->
                <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                    <div class="p-4 border-b border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 flex items-center">
                            <div class="w-3 h-3 bg-amber-500 rounded-full mr-2"></div>
                            å¾…è¾¦äº‹é …
                            <span id="todo-count" class="ml-2 text-sm bg-amber-100 text-amber-800 px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="todo-list" class="p-4 space-y-3 min-h-[300px]">
                        <!-- å‹•æ…‹è¼‰å…¥å¾…è¾¦ä»»å‹™ -->
                    </div>
                </div>

                <!-- In Progress Column -->
                <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                    <div class="p-4 border-b border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 flex items-center">
                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                            é€²è¡Œä¸­
                            <span id="progress-count" class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="progress-list" class="p-4 space-y-3 min-h-[300px]">
                        <!-- å‹•æ…‹è¼‰å…¥é€²è¡Œä¸­ä»»å‹™ -->
                    </div>
                </div>

                <!-- Done Column -->
                <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                    <div class="p-4 border-b border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                            å·²å®Œæˆ
                            <span id="done-count" class="ml-2 text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="done-list" class="p-4 space-y-3 min-h-[300px]">
                        <!-- å‹•æ…‹è¼‰å…¥å·²å®Œæˆä»»å‹™ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="loading-spinner w-12 h-12 border-4 border-slate-200 border-t-indigo-600 rounded-full mb-4 mx-auto"></div>
            <p class="text-slate-600">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <script>
        // å·¥ä½œä»»å‹™è¿½è¹¤å¹³å° - å®Œæ•´ä¿®å¾©ç‰ˆ
        class TaskManagerFixed {
            constructor() {
                this.currentUser = null;
                this.departments = [];
                this.users = [];
                this.tasks = [];
                this.currentDepartment = 'all';
                this.currentView = 'my';
                this.currentSort = 'priority';
                this.searchTerm = '';
                
                // äº‹ä»¶ç›£è½å™¨ç‹€æ…‹
                this.eventListenersInitialized = false;
                
                this.init();
            }

            async init() {
                try {
                    console.log('ğŸš€ TaskManager åˆå§‹åŒ–é–‹å§‹...');
                    await this.loadInitialData();
                    this.initializeEventListeners();
                    this.showAuthModal();
                    console.log('âœ… TaskManager åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                    this.showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }
            }

            // è¼‰å…¥åˆå§‹è³‡æ–™ï¼ˆä½¿ç”¨ localStorage ä½œç‚ºå¾Œå‚™ï¼‰
            async loadInitialData() {
                try {
                    console.log('ğŸ“¦ è¼‰å…¥åˆå§‹è³‡æ–™...');
                    
                    // è¼‰å…¥éƒ¨é–€è³‡æ–™
                    this.departments = this.loadFromStorage('departments', [
                        { id: '1', name: 'å·¥ç¨‹éƒ¨', color: '#3b82f6', order_index: 1 },
                        { id: '2', name: 'ç”¢å“éƒ¨', color: '#10b981', order_index: 2 },
                        { id: '3', name: 'è¡ŒéŠ·éƒ¨', color: '#f59e0b', order_index: 3 },
                        { id: '4', name: 'è¨­è¨ˆéƒ¨', color: '#8b5cf6', order_index: 4 },
                        { id: '5', name: 'æ¥­å‹™éƒ¨', color: '#ef4444', order_index: 5 }
                    ]);

                    // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
                    this.users = this.loadFromStorage('users', [
                        { id: '1', name: 'å¼µå°æ˜', department: 'å·¥ç¨‹éƒ¨', role: 'manager', avatar: null },
                        { id: '2', name: 'æå°è¯', department: 'ç”¢å“éƒ¨', role: 'user', avatar: null },
                        { id: '3', name: 'ç‹å°ç¾', department: 'è¡ŒéŠ·éƒ¨', role: 'user', avatar: null }
                    ]);

                    // è¼‰å…¥ä»»å‹™è³‡æ–™
                    this.tasks = this.loadFromStorage('tasks', [
                        {
                            id: '1',
                            title: 'å®Œæˆä½¿ç”¨è€…ä»‹é¢è¨­è¨ˆ',
                            description: 'è¨­è¨ˆæ–°ç‰ˆæœ¬çš„ä½¿ç”¨è€…ç™»å…¥é é¢',
                            department: 'è¨­è¨ˆéƒ¨',
                            assignee: 'ç‹å°ç¾',
                            priority: 'é«˜',
                            status: 'å¾…è¾¦äº‹é …',
                            due_date: '2024-09-20',
                            created_at: new Date().toISOString()
                        },
                        {
                            id: '2',
                            title: 'å¯¦ä½œ API æ¥å£',
                            description: 'é–‹ç™¼ä½¿ç”¨è€…ç®¡ç†ç›¸é—œçš„ REST API',
                            department: 'å·¥ç¨‹éƒ¨',
                            assignee: 'å¼µå°æ˜',
                            priority: 'ç·Šæ€¥',
                            status: 'é€²è¡Œä¸­',
                            due_date: '2024-09-18',
                            created_at: new Date().toISOString()
                        }
                    ]);

                    console.log('âœ… è³‡æ–™è¼‰å…¥å®Œæˆ:', {
                        departments: this.departments.length,
                        users: this.users.length,
                        tasks: this.tasks.length
                    });

                    // åˆå§‹åŒ–éƒ¨é–€é¸é …
                    this.populateDepartmentSelects();

                } catch (error) {
                    console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                    throw error;
                }
            }

            // å¾ localStorage è¼‰å…¥è³‡æ–™
            loadFromStorage(key, defaultValue) {
                try {
                    const data = localStorage.getItem(`taskManager_${key}`);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (error) {
                    console.warn(`è¼‰å…¥ ${key} å¤±æ•—:`, error);
                    return defaultValue;
                }
            }

            // å„²å­˜è³‡æ–™åˆ° localStorage
            saveToStorage(key, data) {
                try {
                    localStorage.setItem(`taskManager_${key}`, JSON.stringify(data));
                } catch (error) {
                    console.error(`å„²å­˜ ${key} å¤±æ•—:`, error);
                }
            }

            // å¡«å……éƒ¨é–€é¸æ“‡é¸é …
            populateDepartmentSelects() {
                const selects = ['new-user-department', 'task-department'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹é è¨­é¸é …ï¼‰
                        while (select.children.length > 1) {
                            select.removeChild(select.lastChild);
                        }
                        
                        // æ·»åŠ éƒ¨é–€é¸é …
                        this.departments.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept.name;
                            option.textContent = dept.name;
                            select.appendChild(option);
                        });
                    }
                });
            }

            // äº‹ä»¶ç›£è½å™¨åˆå§‹åŒ– - ä½¿ç”¨å…¨åŸŸäº‹ä»¶å§”æ´¾
            initializeEventListeners() {
                if (this.eventListenersInitialized) {
                    console.log('âš ï¸ äº‹ä»¶ç›£è½å™¨å·²åˆå§‹åŒ–ï¼Œè·³é');
                    return;
                }

                console.log('ğŸ”§ åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨...');

                // å…¨åŸŸé»æ“Šäº‹ä»¶å§”æ´¾
                document.addEventListener('click', (e) => this.handleGlobalClick(e));
                
                // å…¨åŸŸè¡¨å–®æäº¤äº‹ä»¶å§”æ´¾
                document.addEventListener('submit', (e) => this.handleGlobalSubmit(e));

                // å…¶ä»–äº‹ä»¶ç›£è½å™¨
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.searchTerm = e.target.value;
                        this.renderTasks();
                    });
                }

                const viewSwitcher = document.getElementById('view-switcher');
                if (viewSwitcher) {
                    viewSwitcher.addEventListener('change', (e) => {
                        this.currentView = e.target.value;
                        this.renderTasks();
                    });
                }

                // éµç›¤äº‹ä»¶
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideAllModals();
                    }
                });

                this.eventListenersInitialized = true;
                console.log('âœ… äº‹ä»¶ç›£è½å™¨åˆå§‹åŒ–å®Œæˆ');
            }

            // å…¨åŸŸé»æ“Šäº‹ä»¶è™•ç†
            handleGlobalClick(e) {
                const target = e.target;
                const id = target.id;

                // è™•ç†ä¸åŒæŒ‰éˆ•é»æ“Š
                switch(id) {
                    case 'add-user-btn':
                        console.log('ğŸ¯ æ–°å¢ä½¿ç”¨è€…æŒ‰éˆ•é»æ“Š');
                        e.preventDefault();
                        this.showAddUserModal();
                        break;
                    
                    case 'cancel-add-user':
                        console.log('ğŸ¯ å–æ¶ˆæ–°å¢ä½¿ç”¨è€…');
                        e.preventDefault();
                        this.hideAddUserModal();
                        break;
                    
                    case 'logout-btn':
                        console.log('ğŸ¯ ç™»å‡ºæŒ‰éˆ•é»æ“Š');
                        this.logout();
                        break;
                    
                    default:
                        // æª¢æŸ¥ä½¿ç”¨è€…é¸æ“‡æŒ‰éˆ•
                        if (target.classList.contains('user-btn')) {
                            const userId = target.getAttribute('data-user-id');
                            this.selectUser(userId);
                        }
                        
                        // æª¢æŸ¥æ’åºæŒ‰éˆ•
                        if (target.classList.contains('sort-btn')) {
                            this.handleSortChange(target.getAttribute('data-sort'));
                        }
                        
                        // æª¢æŸ¥éƒ¨é–€æ¨™ç±¤
                        if (target.classList.contains('dept-tab')) {
                            this.handleDepartmentChange(target.getAttribute('data-dept'));
                        }
                        
                        // æª¢æŸ¥ä»»å‹™å¡ç‰‡
                        if (target.closest('.task-card')) {
                            this.handleTaskCardClick(target.closest('.task-card'));
                        }
                        break;
                }
            }

            // å…¨åŸŸè¡¨å–®æäº¤äº‹ä»¶è™•ç†
            handleGlobalSubmit(e) {
                const form = e.target;
                const id = form.id;
                
                console.log(`ğŸ“‹ è¡¨å–®æäº¤: ${id}`);
                e.preventDefault();

                switch(id) {
                    case 'add-user-form':
                        this.handleAddUser(e);
                        break;
                    
                    case 'add-task-form':
                        this.handleAddTask(e);
                        break;
                    
                    default:
                        console.log('âš ï¸ æœªè™•ç†çš„è¡¨å–®æäº¤');
                        break;
                }
            }

            // é¡¯ç¤ºèªè­‰æ¨¡æ…‹æ¡†
            showAuthModal() {
                console.log('ğŸ” é¡¯ç¤ºèªè­‰æ¨¡æ…‹æ¡†');
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    this.renderUserList();
                }
            }

            // éš±è—èªè­‰æ¨¡æ…‹æ¡†
            hideAuthModal() {
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            }

            // æ¸²æŸ“ä½¿ç”¨è€…åˆ—è¡¨
            renderUserList() {
                console.log('ğŸ‘¥ æ¸²æŸ“ä½¿ç”¨è€…åˆ—è¡¨');
                const userList = document.getElementById('user-list');
                if (!userList) return;

                userList.innerHTML = this.users.map(user => `
                    <button class="user-btn w-full flex items-center p-4 text-left hover:bg-slate-50 rounded-lg border border-slate-200 hover:border-slate-300 transition" data-user-id="${user.id}">
                        <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold mr-3">
                            ${user.name.charAt(0)}
                        </div>
                        <div>
                            <div class="font-medium text-slate-800">${this.escapeHtml(user.name)}</div>
                            <div class="text-sm text-slate-600">${this.escapeHtml(user.department)} - ${this.getRoleName(user.role)}</div>
                        </div>
                    </button>
                `).join('');
            }

            // ç²å–è§’è‰²åç¨±
            getRoleName(role) {
                const roleNames = {
                    'user': 'ä¸€èˆ¬ä½¿ç”¨è€…',
                    'manager': 'ç®¡ç†è€…',
                    'admin': 'ç³»çµ±ç®¡ç†å“¡'
                };
                return roleNames[role] || 'ä¸€èˆ¬ä½¿ç”¨è€…';
            }

            // é¸æ“‡ä½¿ç”¨è€…
            selectUser(userId) {
                console.log('ğŸ‘¤ é¸æ“‡ä½¿ç”¨è€…:', userId);
                const user = this.users.find(u => u.id === userId);
                if (user) {
                    this.currentUser = user;
                    this.hideAuthModal();
                    this.showMainApp();
                }
            }

            // é¡¯ç¤ºä¸»æ‡‰ç”¨
            showMainApp() {
                console.log('ğŸ“± é¡¯ç¤ºä¸»æ‡‰ç”¨');
                const appContainer = document.getElementById('app-container');
                if (appContainer) {
                    appContainer.classList.remove('hidden');
                    
                    // æ›´æ–°ä½¿ç”¨è€…åç¨±é¡¯ç¤º
                    const userNameElement = document.getElementById('current-user-name');
                    if (userNameElement && this.currentUser) {
                        userNameElement.textContent = this.currentUser.name;
                    }
                    
                    // æ¸²æŸ“éƒ¨é–€æ¨™ç±¤å’Œä»»å‹™
                    this.renderDepartmentTabs();
                    this.renderTasks();
                }
            }

            // é¡¯ç¤ºæ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†
            showAddUserModal() {
                console.log('ğŸ“± é¡¯ç¤ºæ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†');
                const modal = document.getElementById('add-user-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    // èšç„¦åˆ°å§“åæ¬„ä½
                    setTimeout(() => {
                        const nameInput = document.getElementById('new-user-name');
                        if (nameInput) {
                            nameInput.focus();
                        }
                    }, 100);
                }
            }

            // éš±è—æ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†
            hideAddUserModal() {
                const modal = document.getElementById('add-user-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    
                    // é‡ç½®è¡¨å–®
                    const form = document.getElementById('add-user-form');
                    if (form) {
                        form.reset();
                    }
                }
            }

            // è™•ç†æ–°å¢ä½¿ç”¨è€…
            handleAddUser(e) {
                console.log('ğŸ‘¤ è™•ç†æ–°å¢ä½¿ç”¨è€…');
                const formData = new FormData(e.target);
                const userData = {
                    id: Date.now().toString(),
                    name: formData.get('name').trim(),
                    department: formData.get('department'),
                    role: formData.get('role'),
                    avatar: null,
                    created_at: new Date().toISOString()
                };

                // é©—è­‰è³‡æ–™
                if (!userData.name || !userData.department) {
                    this.showError('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                    return;
                }

                // æª¢æŸ¥é‡è¤‡ä½¿ç”¨è€…
                if (this.users.find(u => u.name === userData.name)) {
                    this.showError('è©²ä½¿ç”¨è€…åç¨±å·²å­˜åœ¨');
                    return;
                }

                // æ–°å¢ä½¿ç”¨è€…
                this.users.push(userData);
                this.saveToStorage('users', this.users);
                
                console.log('âœ… ä½¿ç”¨è€…æ–°å¢æˆåŠŸ:', userData);
                
                // æ›´æ–° UI
                this.renderUserList();
                this.hideAddUserModal();
                this.showSuccess(`ä½¿ç”¨è€… "${userData.name}" æ–°å¢æˆåŠŸ`);
            }

            // è™•ç†æ–°å¢ä»»å‹™
            handleAddTask(e) {
                console.log('ğŸ“‹ è™•ç†æ–°å¢ä»»å‹™');
                const formData = new FormData(e.target);
                const taskData = {
                    id: Date.now().toString(),
                    title: formData.get('title') || document.getElementById('task-title').value,
                    description: formData.get('description') || document.getElementById('task-description').value,
                    department: document.getElementById('task-department').value,
                    assignee: document.getElementById('task-assignee').value,
                    priority: document.getElementById('task-priority').value,
                    due_date: document.getElementById('task-due-date').value,
                    status: 'å¾…è¾¦äº‹é …',
                    created_at: new Date().toISOString(),
                    creator_id: this.currentUser?.id
                };

                // é©—è­‰å¿…è¦æ¬„ä½
                if (!taskData.title || !taskData.department) {
                    this.showError('è«‹å¡«å¯«ä»»å‹™æ¨™é¡Œå’Œéƒ¨é–€');
                    return;
                }

                // æ–°å¢ä»»å‹™
                this.tasks.push(taskData);
                this.saveToStorage('tasks', this.tasks);
                
                console.log('âœ… ä»»å‹™æ–°å¢æˆåŠŸ:', taskData);
                
                // é‡ç½®è¡¨å–®
                e.target.reset();
                
                // æ›´æ–° UI
                this.renderTasks();
                this.showSuccess(`ä»»å‹™ "${taskData.title}" æ–°å¢æˆåŠŸ`);
            }

            // æ¸²æŸ“éƒ¨é–€æ¨™ç±¤
            renderDepartmentTabs() {
                const tabsContainer = document.getElementById('department-tabs');
                if (!tabsContainer) return;

                const allTab = `
                    <button class="dept-tab px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 border-b-2 border-transparent hover:border-slate-300 transition ${this.currentDepartment === 'all' ? 'tab-active' : ''}" data-dept="all">
                        å…¨éƒ¨éƒ¨é–€
                    </button>
                `;

                const deptTabs = this.departments.map(dept => `
                    <button class="dept-tab px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 border-b-2 border-transparent hover:border-slate-300 transition ${this.currentDepartment === dept.name ? 'tab-active' : ''}" data-dept="${dept.name}">
                        <span class="department-color" style="background-color: ${dept.color};"></span>
                        ${dept.name}
                    </button>
                `).join('');

                tabsContainer.innerHTML = allTab + deptTabs;
            }

            // è™•ç†éƒ¨é–€åˆ‡æ›
            handleDepartmentChange(department) {
                console.log('ğŸ¢ åˆ‡æ›éƒ¨é–€:', department);
                this.currentDepartment = department;
                this.renderDepartmentTabs();
                this.renderTasks();
            }

            // è™•ç†æ’åºåˆ‡æ›
            handleSortChange(sortType) {
                console.log('ğŸ”„ åˆ‡æ›æ’åº:', sortType);
                this.currentSort = sortType;
                
                // æ›´æ–°æ’åºæŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    btn.classList.remove('sort-active');
                });
                document.getElementById(`sort-${sortType}`).classList.add('sort-active');
                
                this.renderTasks();
            }

            // æ¸²æŸ“ä»»å‹™
            renderTasks() {
                console.log('ğŸ“‹ æ¸²æŸ“ä»»å‹™');
                
                // ç²å–ç¯©é¸å¾Œçš„ä»»å‹™
                let filteredTasks = this.getFilteredTasks();
                
                // æ’åºä»»å‹™
                filteredTasks = this.sortTasks(filteredTasks);
                
                // æŒ‰ç‹€æ…‹åˆ†çµ„
                const tasksByStatus = {
                    'å¾…è¾¦äº‹é …': filteredTasks.filter(task => task.status === 'å¾…è¾¦äº‹é …'),
                    'é€²è¡Œä¸­': filteredTasks.filter(task => task.status === 'é€²è¡Œä¸­'),
                    'å·²å®Œæˆ': filteredTasks.filter(task => task.status === 'å·²å®Œæˆ')
                };

                // æ¸²æŸ“å„ç‹€æ…‹çš„ä»»å‹™
                this.renderTaskList('todo-list', tasksByStatus['å¾…è¾¦äº‹é …']);
                this.renderTaskList('progress-list', tasksByStatus['é€²è¡Œä¸­']);
                this.renderTaskList('done-list', tasksByStatus['å·²å®Œæˆ']);

                // æ›´æ–°è¨ˆæ•¸
                document.getElementById('todo-count').textContent = tasksByStatus['å¾…è¾¦äº‹é …'].length;
                document.getElementById('progress-count').textContent = tasksByStatus['é€²è¡Œä¸­'].length;
                document.getElementById('done-count').textContent = tasksByStatus['å·²å®Œæˆ'].length;
            }

            // ç²å–ç¯©é¸å¾Œçš„ä»»å‹™
            getFilteredTasks() {
                return this.tasks.filter(task => {
                    // éƒ¨é–€ç¯©é¸
                    const departmentMatch = this.currentDepartment === 'all' || task.department === this.currentDepartment;
                    
                    // æª¢è¦–ç¯©é¸
                    let viewMatch = true;
                    if (this.currentView === 'my' && this.currentUser) {
                        viewMatch = task.assignee === this.currentUser.name || task.creator_id === this.currentUser.id;
                    } else if (this.currentView === 'department' && this.currentUser) {
                        viewMatch = task.department === this.currentUser.department;
                    }
                    
                    // æœå°‹ç¯©é¸
                    const searchMatch = !this.searchTerm || 
                        task.title.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                        task.description.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                        task.assignee.toLowerCase().includes(this.searchTerm.toLowerCase());
                    
                    return departmentMatch && viewMatch && searchMatch;
                });
            }

            // æ’åºä»»å‹™
            sortTasks(tasks) {
                return tasks.sort((a, b) => {
                    switch (this.currentSort) {
                        case 'priority':
                            const priorityOrder = { 'ç·Šæ€¥': 4, 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
                            return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
                        case 'date':
                            return new Date(b.created_at) - new Date(a.created_at);
                        case 'title':
                            return a.title.localeCompare(b.title);
                        default:
                            return 0;
                    }
                });
            }

            // æ¸²æŸ“ä»»å‹™åˆ—è¡¨
            renderTaskList(containerId, tasks) {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (tasks.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-8">æš«ç„¡ä»»å‹™</div>';
                    return;
                }

                container.innerHTML = tasks.map(task => this.createTaskCard(task)).join('');
            }

            // å‰µå»ºä»»å‹™å¡ç‰‡
            createTaskCard(task) {
                const priorityEmoji = {
                    'ç·Šæ€¥': 'ğŸ”´',
                    'é«˜': 'ğŸŸ¡',
                    'ä¸­': 'ğŸ”µ',
                    'ä½': 'âšª'
                };

                const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString('zh-TW') : '';
                const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== 'å·²å®Œæˆ';

                return `
                    <div class="task-card bg-white border border-slate-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer" data-task-id="${task.id}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${priorityEmoji[task.priority]}</span>
                                <span class="priority-badge-${task.priority} text-xs px-2 py-1 rounded-full font-medium">${task.priority}</span>
                                ${isOverdue ? '<span class="text-red-500 text-xs">âš ï¸ é€¾æœŸ</span>' : ''}
                            </div>
                            <button class="text-slate-400 hover:text-slate-600 expand-arrow">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <h4 class="font-semibold text-slate-800 mb-1">${this.escapeHtml(task.title)}</h4>
                        <p class="text-sm text-slate-600 mb-2">${this.escapeHtml(task.description || '')}</p>
                        
                        <div class="task-details">
                            <div class="text-xs text-slate-500 space-y-1 pt-2 border-t border-slate-100">
                                <div><strong>éƒ¨é–€:</strong> ${this.escapeHtml(task.department)}</div>
                                <div><strong>è² è²¬äºº:</strong> ${this.escapeHtml(task.assignee || 'æœªåˆ†é…')}</div>
                                ${dueDate ? `<div><strong>æˆªæ­¢æ—¥æœŸ:</strong> ${dueDate}</div>` : ''}
                                <div><strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(task.created_at).toLocaleDateString('zh-TW')}</div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs text-slate-500">${this.escapeHtml(task.department)}</span>
                            <div class="flex space-x-2">
                                <button class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition" onclick="taskManager.changeTaskStatus('${task.id}', 'å¾…è¾¦äº‹é …')">å¾…è¾¦</button>
                                <button class="text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 transition" onclick="taskManager.changeTaskStatus('${task.id}', 'é€²è¡Œä¸­')">é€²è¡Œä¸­</button>
                                <button class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition" onclick="taskManager.changeTaskStatus('${task.id}', 'å·²å®Œæˆ')">å®Œæˆ</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // è™•ç†ä»»å‹™å¡ç‰‡é»æ“Š
            handleTaskCardClick(card) {
                card.classList.toggle('expanded');
            }

            // æ›´æ”¹ä»»å‹™ç‹€æ…‹
            changeTaskStatus(taskId, newStatus) {
                console.log('ğŸ”„ æ›´æ”¹ä»»å‹™ç‹€æ…‹:', taskId, newStatus);
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = newStatus;
                    if (newStatus === 'å·²å®Œæˆ') {
                        task.completed_at = new Date().toISOString();
                    }
                    this.saveToStorage('tasks', this.tasks);
                    this.renderTasks();
                    this.showSuccess(`ä»»å‹™ç‹€æ…‹å·²æ›´æ–°ç‚º "${newStatus}"`);
                }
            }

            // ç™»å‡º
            logout() {
                console.log('ğŸšª ä½¿ç”¨è€…ç™»å‡º');
                this.currentUser = null;
                document.getElementById('app-container').classList.add('hidden');
                this.showAuthModal();
            }

            // éš±è—æ‰€æœ‰æ¨¡æ…‹æ¡†
            hideAllModals() {
                const modals = ['add-user-modal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal && !modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                    }
                });
            }

            // å·¥å…·å‡½æ•¸
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showError(message) {
                console.error('âŒ éŒ¯èª¤:', message);
                alert(message); // ç°¡å–®çš„éŒ¯èª¤é¡¯ç¤ºï¼Œå¯ä»¥å¾ŒçºŒæ”¹ç‚ºæ›´å¥½çš„ UI
            }

            showSuccess(message) {
                console.log('âœ… æˆåŠŸ:', message);
                // å¯ä»¥æ·»åŠ æ›´å¥½çš„æˆåŠŸæç¤º UI
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 3000);
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        let taskManager;

        // DOM è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ DOM è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ–ä»»å‹™ç®¡ç†å™¨');
            taskManager = new TaskManagerFixed();
        });

        // å‚™ç”¨åˆå§‹åŒ–
        window.addEventListener('load', () => {
            if (!taskManager) {
                console.log('ğŸ”„ ä½¿ç”¨å‚™ç”¨åˆå§‹åŒ–');
                taskManager = new TaskManagerFixed();
            }
        });

        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', (e) => {
            console.error('ğŸ’¥ å…¨åŸŸéŒ¯èª¤:', e.error);
        });
    </script>
</body>
</html>
