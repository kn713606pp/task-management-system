<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»å‹™ç®¡ç†ç³»çµ± - æœ€çµ‚ä¿®å¾©ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .task-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .sortable-ghost {
            opacity: 0.5;
        }
        .sortable-chosen {
            transform: rotate(5deg);
        }
        .status-pending { border-left: 4px solid #f59e0b; }
        .status-in-progress { border-left: 4px solid #3b82f6; }
        .status-completed { border-left: 4px solid #10b981; }
        .success-message {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .button-clicked {
            animation: buttonPress 0.1s ease-in-out;
        }
        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <!-- é€šçŸ¥ç³»çµ± -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="min-h-screen">
        <!-- èªè­‰æ¨¡æ…‹æ¡† -->
        <div id="auth-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-40 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8 fade-in">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-tasks text-white text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-800 mb-2">ä»»å‹™ç®¡ç†ç³»çµ±</h1>
                    <p class="text-slate-600">è«‹é¸æ“‡ä½¿ç”¨è€…æˆ–æ–°å¢æ–°ä½¿ç”¨è€…</p>
                </div>

                <!-- ä½¿ç”¨è€…é¸æ“‡åˆ—è¡¨ -->
                <div id="user-list" class="space-y-3 mb-6">
                    <!-- å‹•æ…‹ç”Ÿæˆä½¿ç”¨è€…åˆ—è¡¨ -->
                </div>

                <!-- æ–°å¢ä½¿ç”¨è€…æŒ‰éˆ• -->
                <button 
                    type="button" 
                    id="add-user-btn" 
                    class="w-full flex items-center justify-center px-4 py-3 text-sm font-semibold text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg transition-all duration-200 border border-indigo-200 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    data-test="add-user-button"
                >
                    <i class="fas fa-plus mr-2"></i>
                    æ–°å¢ä½¿ç”¨è€…
                </button>

                <!-- åµéŒ¯ä¿¡æ¯ï¼ˆé–‹ç™¼æ™‚é¡¯ç¤ºï¼‰ -->
                <div id="auth-debug" class="mt-4 text-xs text-slate-500 hidden">
                    <p>Debug: èªè­‰æ¨¡æ…‹æ¡†å·²è¼‰å…¥</p>
                    <p id="auth-debug-info"></p>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡† -->
        <div id="add-user-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 fade-in">
                <h2 class="text-xl font-semibold mb-6 text-slate-800 flex items-center">
                    <i class="fas fa-user-plus mr-2 text-indigo-600"></i>
                    æ–°å¢ä½¿ç”¨è€…
                </h2>
                
                <!-- éŒ¯èª¤è¨Šæ¯å€åŸŸ -->
                <div id="add-user-error" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm hidden">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="add-user-error-text"></span>
                </div>
                
                <form id="add-user-form" class="space-y-4" novalidate>
                    <div>
                        <label for="new-user-name" class="block text-sm font-medium text-slate-700 mb-1">
                            å§“å <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="new-user-name" 
                            name="name"
                            required
                            maxlength="20"
                            class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                            placeholder="è«‹è¼¸å…¥ä½¿ç”¨è€…å§“å"
                            autocomplete="name"
                        >
                        <div class="text-xs text-slate-500 mt-1">æœ€å¤š 20 å€‹å­—å…ƒ</div>
                    </div>
                    
                    <div>
                        <label for="new-user-department" class="block text-sm font-medium text-slate-700 mb-1">
                            éƒ¨é–€ <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="new-user-department" 
                            name="department"
                            required
                            class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                        >
                            <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
                            <option value="å·¥ç¨‹éƒ¨">å·¥ç¨‹éƒ¨</option>
                            <option value="è¡ŒéŠ·éƒ¨">è¡ŒéŠ·éƒ¨</option>
                            <option value="è²¡å‹™éƒ¨">è²¡å‹™éƒ¨</option>
                            <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                            <option value="æ¥­å‹™éƒ¨">æ¥­å‹™éƒ¨</option>
                            <option value="è¨­è¨ˆéƒ¨">è¨­è¨ˆéƒ¨</option>
                            <option value="å®¢æœéƒ¨">å®¢æœéƒ¨</option>
                            <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button 
                            type="submit" 
                            id="submit-add-user"
                            class="flex-1 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white py-2 px-4 rounded-md font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                        >
                            <i class="fas fa-check mr-2"></i>
                            ç¢ºå®šæ–°å¢
                        </button>
                        <button 
                            type="button" 
                            id="cancel-add-user" 
                            class="flex-1 bg-slate-300 hover:bg-slate-400 text-slate-700 py-2 px-4 rounded-md font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2"
                        >
                            <i class="fas fa-times mr-2"></i>
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>

                <!-- è¡¨å–®åµéŒ¯ä¿¡æ¯ -->
                <div id="form-debug" class="mt-4 text-xs text-slate-500 hidden">
                    <p>Debug: æ–°å¢ä½¿ç”¨è€…è¡¨å–®å·²è¼‰å…¥</p>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div id="main-content" class="hidden">
            <!-- é ‚éƒ¨å°èˆª -->
            <nav class="bg-white shadow-sm border-b border-slate-200">
                <div class="container mx-auto px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tasks text-white text-sm"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold text-slate-800">ä»»å‹™ç®¡ç†ç³»çµ±</h1>
                                <p class="text-sm text-slate-600" id="current-user-info">æ­¡è¿ä½¿ç”¨</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="debug-toggle" class="text-slate-500 hover:text-slate-700 p-2 rounded-lg hover:bg-slate-100" title="åˆ‡æ›åµéŒ¯æ¨¡å¼">
                                <i class="fas fa-bug"></i>
                            </button>
                            <button id="logout-btn" class="flex items-center px-4 py-2 text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="fas fa-sign-out-alt mr-2"></i>
                                ç™»å‡º
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- çµ±è¨ˆå€åŸŸ -->
            <div class="container mx-auto px-6 py-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                <i class="fas fa-tasks text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-slate-800" id="total-tasks">0</p>
                                <p class="text-sm text-slate-600">ç¸½ä»»å‹™æ•¸</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-slate-800" id="pending-tasks">0</p>
                                <p class="text-sm text-slate-600">å¾…è™•ç†</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                <i class="fas fa-spinner text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-slate-800" id="in-progress-tasks">0</p>
                                <p class="text-sm text-slate-600">é€²è¡Œä¸­</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                                <i class="fas fa-check text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-slate-800" id="completed-tasks">0</p>
                                <p class="text-sm text-slate-600">å·²å®Œæˆ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä»»å‹™ç®¡ç†å€åŸŸ -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-slate-800">ä»»å‹™ç®¡ç†</h2>
                        <button id="add-task-btn" class="flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors font-medium">
                            <i class="fas fa-plus mr-2"></i>
                            æ–°å¢ä»»å‹™
                        </button>
                    </div>
                    
                    <!-- ä»»å‹™åˆ—è¡¨ -->
                    <div id="tasks-container" class="space-y-4">
                        <!-- å‹•æ…‹ç”Ÿæˆä»»å‹™ -->
                        <div class="text-center py-8 text-slate-500">
                            <i class="fas fa-clipboard-list text-4xl mb-4"></i>
                            <p>æš«ç„¡ä»»å‹™ï¼Œé»æ“Šã€Œæ–°å¢ä»»å‹™ã€é–‹å§‹ä½¿ç”¨</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TaskManagerFinal {
            constructor() {
                this.currentUser = null;
                this.users = this.loadFromStorage('taskManager_users', []);
                this.tasks = this.loadFromStorage('taskManager_tasks', []);
                this.debugMode = false;
                this.eventListenersSet = false;
                
                console.log('ğŸš€ TaskManager æœ€çµ‚ç‰ˆæœ¬åˆå§‹åŒ–é–‹å§‹...');
                this.init();
            }

            // å·¥å…·æ–¹æ³•
            debug(message, data = null) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;
                console.log(logMessage, data || '');
                
                // æ›´æ–°åµéŒ¯ä¿¡æ¯é¡¯ç¤º
                if (this.debugMode) {
                    this.updateDebugInfo(logMessage);
                }
            }

            updateDebugInfo(message) {
                const authDebugInfo = document.getElementById('auth-debug-info');
                if (authDebugInfo) {
                    authDebugInfo.textContent = message;
                }
            }

            loadFromStorage(key, defaultValue) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (error) {
                    console.warn(`è¼‰å…¥ ${key} å¤±æ•—:`, error);
                    return defaultValue;
                }
            }

            saveToStorage(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    this.debug(`${key} å·²å„²å­˜`);
                } catch (error) {
                    console.error(`å„²å­˜ ${key} å¤±æ•—:`, error);
                }
            }

            // åˆå§‹åŒ–
            init() {
                this.debug('é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼');
                
                // ç¢ºä¿åœ¨ DOM å®Œå…¨è¼‰å…¥å¾Œåˆå§‹åŒ–
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.performInitialization();
                    });
                } else {
                    this.performInitialization();
                }
            }

            performInitialization() {
                try {
                    this.debug('åŸ·è¡Œåˆå§‹åŒ–ç¨‹åº');
                    
                    // è¨­å®šäº‹ä»¶ç›£è½å™¨
                    this.setupEventListeners();
                    
                    // å»ºç«‹é è¨­è³‡æ–™
                    this.initializeDefaultData();
                    
                    // é¡¯ç¤ºèªè­‰ç•Œé¢
                    this.showAuthenticationUI();
                    
                    this.debug('âœ… åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                    this.showNotification('ç³»çµ±åˆå§‹åŒ–å¤±æ•—', 'error');
                }
            }

            // äº‹ä»¶è™•ç†ç³»çµ±
            setupEventListeners() {
                if (this.eventListenersSet) {
                    this.debug('âš ï¸ äº‹ä»¶ç›£è½å™¨å·²è¨­å®šï¼Œè·³é');
                    return;
                }

                this.debug('ğŸ”§ è¨­å®šäº‹ä»¶ç›£è½å™¨');

                // å…¨åŸŸé»æ“Šäº‹ä»¶è™•ç†
                document.addEventListener('click', (e) => {
                    this.handleClick(e);
                });

                // å…¨åŸŸè¡¨å–®æäº¤äº‹ä»¶è™•ç†
                document.addEventListener('submit', (e) => {
                    this.handleSubmit(e);
                });

                // éµç›¤äº‹ä»¶è™•ç†
                document.addEventListener('keydown', (e) => {
                    this.handleKeydown(e);
                });

                this.eventListenersSet = true;
                this.debug('âœ… äº‹ä»¶ç›£è½å™¨è¨­å®šå®Œæˆ');
            }

            handleClick(e) {
                const target = e.target;
                const id = target.id;
                const closest = target.closest('[id]');
                const closestId = closest ? closest.id : null;

                // è¨˜éŒ„é»æ“Šäº‹ä»¶ï¼ˆé™¤éæ˜¯å¾ˆé »ç¹çš„äº‹ä»¶ï¼‰
                if (!['debug-toggle'].includes(id)) {
                    this.debug(`é»æ“Šäº‹ä»¶: ${id || closestId || target.className.split(' ')[0]}`);
                }

                // æŒ‰éˆ•é»æ“Šå‹•ç•«æ•ˆæœ
                if (target.tagName === 'BUTTON') {
                    target.classList.add('button-clicked');
                    setTimeout(() => target.classList.remove('button-clicked'), 150);
                }

                // è™•ç†ç‰¹å®šæŒ‰éˆ•é»æ“Š
                switch(id) {
                    case 'add-user-btn':
                        this.debug('ğŸ¯ æ–°å¢ä½¿ç”¨è€…æŒ‰éˆ•è¢«é»æ“Š');
                        e.preventDefault();
                        e.stopPropagation();
                        this.handleAddUserButtonClick();
                        break;
                    
                    case 'cancel-add-user':
                        this.debug('ğŸ¯ å–æ¶ˆæ–°å¢ä½¿ç”¨è€…');
                        e.preventDefault();
                        this.hideAddUserModal();
                        break;
                    
                    case 'logout-btn':
                        this.debug('ğŸ¯ ç™»å‡º');
                        this.logout();
                        break;
                    
                    case 'debug-toggle':
                        this.toggleDebugMode();
                        break;
                    
                    default:
                        // æª¢æŸ¥ä½¿ç”¨è€…é¸æ“‡æŒ‰éˆ•
                        if (target.classList.contains('user-select-btn') || closestId === 'user-select-btn') {
                            const button = target.classList.contains('user-select-btn') ? target : closest;
                            const userId = button.getAttribute('data-user-id');
                            if (userId) {
                                this.debug(`ğŸ¯ é¸æ“‡ä½¿ç”¨è€…: ${userId}`);
                                this.selectUser(userId);
                            }
                        }
                        break;
                }
            }

            handleSubmit(e) {
                const form = e.target;
                const id = form.id;
                
                this.debug(`ğŸ“‹ è¡¨å–®æäº¤: ${id}`);
                e.preventDefault();

                switch(id) {
                    case 'add-user-form':
                        this.handleAddUserFormSubmit(e);
                        break;
                    
                    default:
                        this.debug('âš ï¸ æœªè™•ç†çš„è¡¨å–®æäº¤');
                        break;
                }
            }

            handleKeydown(e) {
                // ESC é—œé–‰æ¨¡æ…‹æ¡†
                if (e.key === 'Escape') {
                    this.hideAllModals();
                }
            }

            // æ–°å¢ä½¿ç”¨è€…åŠŸèƒ½
            handleAddUserButtonClick() {
                this.debug('ğŸ”¥ è™•ç†æ–°å¢ä½¿ç”¨è€…æŒ‰éˆ•é»æ“Š');
                
                try {
                    this.showAddUserModal();
                    this.debug('âœ… æ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†å·²é¡¯ç¤º');
                } catch (error) {
                    console.error('âŒ é¡¯ç¤ºæ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†å¤±æ•—:', error);
                    this.showNotification('ç„¡æ³•é–‹å•Ÿæ–°å¢ä½¿ç”¨è€…è¦–çª—', 'error');
                }
            }

            showAddUserModal() {
                this.debug('ğŸ“± é¡¯ç¤ºæ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†');
                
                const modal = document.getElementById('add-user-modal');
                if (!modal) {
                    throw new Error('æ‰¾ä¸åˆ°æ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†å…ƒç´ ');
                }

                // é¡¯ç¤ºæ¨¡æ…‹æ¡†
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // æ¸…ç©ºä¸¦é‡ç½®è¡¨å–®
                this.resetAddUserForm();
                
                // èšç„¦åˆ°å§“åæ¬„ä½
                setTimeout(() => {
                    const nameInput = document.getElementById('new-user-name');
                    if (nameInput) {
                        nameInput.focus();
                        nameInput.select();
                    }
                }, 150);
                
                this.debug('âœ… æ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†å·²é¡¯ç¤º');
            }

            hideAddUserModal() {
                this.debug('ğŸ“± éš±è—æ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†');
                
                const modal = document.getElementById('add-user-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    
                    // æ¸…ç©ºéŒ¯èª¤è¨Šæ¯
                    this.hideAddUserError();
                    
                    this.debug('âœ… æ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†å·²éš±è—');
                }
            }

            resetAddUserForm() {
                const form = document.getElementById('add-user-form');
                if (form) {
                    form.reset();
                    
                    // ç§»é™¤é©—è­‰æ¨£å¼
                    const inputs = form.querySelectorAll('input, select');
                    inputs.forEach(input => {
                        input.classList.remove('border-red-500', 'border-green-500');
                    });
                    
                    this.debug('ğŸ“‹ æ–°å¢ä½¿ç”¨è€…è¡¨å–®å·²é‡ç½®');
                }
            }

            handleAddUserFormSubmit(e) {
                this.debug('ğŸ“‹ è™•ç†æ–°å¢ä½¿ç”¨è€…è¡¨å–®æäº¤');
                
                const formData = new FormData(e.target);
                const name = formData.get('name')?.trim();
                const department = formData.get('department');
                
                // é©—è­‰è¼¸å…¥
                const validation = this.validateUserInput(name, department);
                if (!validation.valid) {
                    this.showAddUserError(validation.message);
                    this.highlightInvalidFields(validation.fields);
                    return;
                }

                // æª¢æŸ¥é‡è¤‡ä½¿ç”¨è€…
                const existingUser = this.users.find(user => 
                    user.name.toLowerCase() === name.toLowerCase()
                );
                if (existingUser) {
                    this.showAddUserError(`ä½¿ç”¨è€…ã€Œ${name}ã€å·²å­˜åœ¨`);
                    this.highlightInvalidFields(['name']);
                    return;
                }

                // å»ºç«‹æ–°ä½¿ç”¨è€…
                const newUser = {
                    id: this.generateId(),
                    name: name,
                    department: department,
                    createdAt: new Date().toISOString()
                };

                this.debug('ğŸ‘¤ å»ºç«‹æ–°ä½¿ç”¨è€…:', newUser);
                
                // å„²å­˜ä½¿ç”¨è€…
                this.users.push(newUser);
                this.saveUsers();
                
                // æ›´æ–° UI
                this.renderUserList();
                this.hideAddUserModal();
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                this.showNotification(`ä½¿ç”¨è€…ã€Œ${name}ã€å·²æˆåŠŸæ–°å¢`, 'success');
                
                this.debug('âœ… æ–°å¢ä½¿ç”¨è€…å®Œæˆ');
            }

            validateUserInput(name, department) {
                const errors = [];
                const fields = [];

                if (!name || name.length === 0) {
                    errors.push('è«‹è¼¸å…¥ä½¿ç”¨è€…å§“å');
                    fields.push('name');
                } else if (name.length > 20) {
                    errors.push('å§“åä¸èƒ½è¶…é 20 å€‹å­—å…ƒ');
                    fields.push('name');
                } else if (!/^[\u4e00-\u9fa5a-zA-Z\s]+$/.test(name)) {
                    errors.push('å§“ååªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡å’Œç©ºæ ¼');
                    fields.push('name');
                }

                if (!department) {
                    errors.push('è«‹é¸æ“‡éƒ¨é–€');
                    fields.push('department');
                }

                return {
                    valid: errors.length === 0,
                    message: errors.join('ã€'),
                    fields: fields
                };
            }

            highlightInvalidFields(fields) {
                // é‡ç½®æ‰€æœ‰æ¬„ä½æ¨£å¼
                const allInputs = document.querySelectorAll('#add-user-form input, #add-user-form select');
                allInputs.forEach(input => {
                    input.classList.remove('border-red-500');
                });

                // é«˜äº®éŒ¯èª¤æ¬„ä½
                fields.forEach(fieldName => {
                    const field = document.getElementById(`new-user-${fieldName}`);
                    if (field) {
                        field.classList.add('border-red-500');
                        field.focus();
                    }
                });
            }

            showAddUserError(message) {
                const errorDiv = document.getElementById('add-user-error');
                const errorText = document.getElementById('add-user-error-text');
                
                if (errorDiv && errorText) {
                    errorText.textContent = message;
                    errorDiv.classList.remove('hidden');
                    
                    // è‡ªå‹•éš±è—éŒ¯èª¤è¨Šæ¯
                    setTimeout(() => {
                        this.hideAddUserError();
                    }, 5000);
                }
            }

            hideAddUserError() {
                const errorDiv = document.getElementById('add-user-error');
                if (errorDiv) {
                    errorDiv.classList.add('hidden');
                }
            }

            // ä½¿ç”¨è€…é¸æ“‡
            selectUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (user) {
                    this.currentUser = user;
                    this.debug('ğŸ‘¤ ä½¿ç”¨è€…å·²é¸æ“‡:', user);
                    
                    this.hideAuthModal();
                    this.showMainContent();
                    this.updateUserInterface();
                    
                    this.showNotification(`æ­¡è¿ï¼Œ${user.name}ï¼`, 'info');
                }
            }

            // UI ç®¡ç†
            showAuthenticationUI() {
                this.debug('ğŸ” é¡¯ç¤ºèªè­‰ç•Œé¢');
                this.showAuthModal();
                this.renderUserList();
            }

            showAuthModal() {
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    this.debug('ğŸ” èªè­‰æ¨¡æ…‹æ¡†å·²é¡¯ç¤º');
                }
            }

            hideAuthModal() {
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    this.debug('ğŸ” èªè­‰æ¨¡æ…‹æ¡†å·²éš±è—');
                }
            }

            showMainContent() {
                const mainContent = document.getElementById('main-content');
                if (mainContent) {
                    mainContent.classList.remove('hidden');
                    this.debug('ğŸ“± ä¸»è¦å…§å®¹å·²é¡¯ç¤º');
                }
            }

            hideMainContent() {
                const mainContent = document.getElementById('main-content');
                if (mainContent) {
                    mainContent.classList.add('hidden');
                    this.debug('ğŸ“± ä¸»è¦å…§å®¹å·²éš±è—');
                }
            }

            renderUserList() {
                this.debug('ğŸ‘¥ æ¸²æŸ“ä½¿ç”¨è€…åˆ—è¡¨');
                const userList = document.getElementById('user-list');
                if (!userList) return;

                if (this.users.length === 0) {
                    userList.innerHTML = `
                        <div class="text-center py-6 text-slate-500">
                            <i class="fas fa-user-plus text-3xl mb-2"></i>
                            <p>å°šç„¡ä½¿ç”¨è€…ï¼Œè«‹æ–°å¢ç¬¬ä¸€å€‹ä½¿ç”¨è€…</p>
                        </div>
                    `;
                    return;
                }

                userList.innerHTML = this.users.map(user => `
                    <button 
                        class="user-select-btn w-full flex items-center p-4 text-left hover:bg-slate-50 rounded-lg border border-slate-200 hover:border-slate-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        data-user-id="${user.id}"
                        title="é¸æ“‡ ${user.name}"
                    >
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full flex items-center justify-center text-white font-semibold mr-3">
                            ${user.name.charAt(0)}
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-slate-800">${this.escapeHtml(user.name)}</div>
                            <div class="text-sm text-slate-600">${this.escapeHtml(user.department)}</div>
                        </div>
                        <i class="fas fa-chevron-right text-slate-400"></i>
                    </button>
                `).join('');
                
                this.debug(`âœ… å·²æ¸²æŸ“ ${this.users.length} å€‹ä½¿ç”¨è€…`);
            }

            updateUserInterface() {
                this.debug('ğŸ”„ æ›´æ–°ä½¿ç”¨è€…ç•Œé¢');
                
                if (this.currentUser) {
                    const userInfo = document.getElementById('current-user-info');
                    if (userInfo) {
                        userInfo.textContent = `${this.currentUser.name} - ${this.currentUser.department}`;
                    }
                }
                
                this.updateStatistics();
            }

            updateStatistics() {
                const total = this.tasks.length;
                const pending = this.tasks.filter(t => t.status === 'pending').length;
                const inProgress = this.tasks.filter(t => t.status === 'in-progress').length;
                const completed = this.tasks.filter(t => t.status === 'completed').length;

                this.setElementText('total-tasks', total);
                this.setElementText('pending-tasks', pending);
                this.setElementText('in-progress-tasks', inProgress);
                this.setElementText('completed-tasks', completed);
            }

            // é€šçŸ¥ç³»çµ±
            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                if (!container) return;

                const notification = document.createElement('div');
                notification.className = `success-message bg-white rounded-lg shadow-lg border-l-4 p-4 mb-2 max-w-sm`;
                
                let icon, bgColor, borderColor;
                switch(type) {
                    case 'success':
                        icon = 'fas fa-check-circle text-green-500';
                        borderColor = 'border-green-500';
                        break;
                    case 'error':
                        icon = 'fas fa-exclamation-circle text-red-500';
                        borderColor = 'border-red-500';
                        break;
                    case 'warning':
                        icon = 'fas fa-exclamation-triangle text-yellow-500';
                        borderColor = 'border-yellow-500';
                        break;
                    default:
                        icon = 'fas fa-info-circle text-blue-500';
                        borderColor = 'border-blue-500';
                        break;
                }

                notification.className += ` ${borderColor}`;
                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="${icon} mr-3"></i>
                        <span class="text-slate-800 font-medium">${this.escapeHtml(message)}</span>
                        <button class="ml-auto text-slate-400 hover:text-slate-600 close-notification">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                // é—œé–‰æŒ‰éˆ•äº‹ä»¶
                notification.querySelector('.close-notification').addEventListener('click', () => {
                    this.removeNotification(notification);
                });

                container.appendChild(notification);

                // è‡ªå‹•ç§»é™¤
                setTimeout(() => {
                    this.removeNotification(notification);
                }, 4000);
            }

            removeNotification(notification) {
                if (notification && notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }

            // è³‡æ–™ç®¡ç†
            initializeDefaultData() {
                if (this.users.length === 0) {
                    this.debug('ğŸ‘¥ å»ºç«‹é è¨­ä½¿ç”¨è€…');
                    this.createDefaultUsers();
                }
                
                if (this.tasks.length === 0) {
                    this.debug('ğŸ“‹ å»ºç«‹ç¯„ä¾‹ä»»å‹™');
                    this.createSampleTasks();
                }
            }

            createDefaultUsers() {
                this.users = [
                    {
                        id: this.generateId(),
                        name: 'å¼µå°æ˜',
                        department: 'å·¥ç¨‹éƒ¨',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: this.generateId(),
                        name: 'æå°è¯',
                        department: 'è¡ŒéŠ·éƒ¨',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: this.generateId(),
                        name: 'ç‹å°ç¾',
                        department: 'äººäº‹éƒ¨',
                        createdAt: new Date().toISOString()
                    }
                ];
                this.saveUsers();
                this.debug('âœ… é è¨­ä½¿ç”¨è€…å·²å»ºç«‹');
            }

            createSampleTasks() {
                this.tasks = [
                    {
                        id: this.generateId(),
                        title: 'ç³»çµ±åŠŸèƒ½é–‹ç™¼',
                        description: 'é–‹ç™¼ä½¿ç”¨è€…ç®¡ç†å’Œä»»å‹™åˆ†é…åŠŸèƒ½',
                        assignee: 'å¼µå°æ˜',
                        status: 'in-progress',
                        priority: 'high',
                        department: 'å·¥ç¨‹éƒ¨',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: this.generateId(),
                        title: 'å¸‚å ´æ¨å»£æ´»å‹•',
                        description: 'è¦åŠƒ Q4 ç”¢å“æ¨å»£æ´»å‹•',
                        assignee: 'æå°è¯',
                        status: 'pending',
                        priority: 'medium',
                        department: 'è¡ŒéŠ·éƒ¨',
                        createdAt: new Date().toISOString()
                    }
                ];
                this.saveTasks();
                this.debug('âœ… ç¯„ä¾‹ä»»å‹™å·²å»ºç«‹');
            }

            saveUsers() {
                this.saveToStorage('taskManager_users', this.users);
            }

            saveTasks() {
                this.saveToStorage('taskManager_tasks', this.tasks);
            }

            // å·¥å…·æ–¹æ³•
            generateId() {
                return Date.now().toString() + Math.random().toString(36).substr(2, 9);
            }

            setElementText(id, text) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            hideAllModals() {
                const modals = ['add-user-modal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal && !modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                    }
                });
            }

            toggleDebugMode() {
                this.debugMode = !this.debugMode;
                
                // åˆ‡æ›åµéŒ¯ä¿¡æ¯é¡¯ç¤º
                const debugElements = document.querySelectorAll('[id$="-debug"]');
                debugElements.forEach(el => {
                    el.classList.toggle('hidden', !this.debugMode);
                });
                
                this.debug(`ğŸ› Debug æ¨¡å¼: ${this.debugMode ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
                this.showNotification(`åµéŒ¯æ¨¡å¼${this.debugMode ? 'é–‹å•Ÿ' : 'é—œé–‰'}`, 'info');
            }

            logout() {
                this.debug('ğŸšª ä½¿ç”¨è€…ç™»å‡º');
                this.currentUser = null;
                this.hideMainContent();
                this.showAuthenticationUI();
                this.showNotification('å·²ç™»å‡º', 'info');
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        console.log('ğŸš€ è¼‰å…¥ä»»å‹™ç®¡ç†ç³»çµ±æœ€çµ‚ç‰ˆæœ¬...');

        // ç¢ºä¿åœ¨ DOM å®Œå…¨è¼‰å…¥å¾Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('ğŸ“„ DOM è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ–ä»»å‹™ç®¡ç†å™¨');
                window.taskManager = new TaskManagerFinal();
            });
        } else {
            console.log('ğŸ“„ DOM å·²è¼‰å…¥ï¼Œç«‹å³åˆå§‹åŒ–ä»»å‹™ç®¡ç†å™¨');
            window.taskManager = new TaskManagerFinal();
        }

        // å‚™ç”¨åˆå§‹åŒ–æ–¹æ³•
        window.addEventListener('load', () => {
            if (!window.taskManager) {
                console.log('ğŸ”„ ä½¿ç”¨å‚™ç”¨æ–¹æ³•åˆå§‹åŒ–ä»»å‹™ç®¡ç†å™¨');
                window.taskManager = new TaskManagerFinal();
            }
        });

        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', (e) => {
            console.error('ğŸ’¥ å…¨åŸŸéŒ¯èª¤:', e.error);
            if (window.taskManager && window.taskManager.showNotification) {
                window.taskManager.showNotification('ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
            }
        });

        // é˜²æ­¢æ„å¤–é—œé–‰é é¢
        window.addEventListener('beforeunload', (e) => {
            if (window.taskManager && window.taskManager.currentUser) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
