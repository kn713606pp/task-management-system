<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作任務追蹤平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        
        .task-card { 
            transition: all 0.2s ease-in-out; 
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.45);
            transform: translateY(-1px);
        }
        
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        
        .tab-active { 
            color: #4338ca; 
            background-color: #eef2ff;
            border-bottom: 2px solid #4338ca;
        }
        
        .sortable-ghost {
            opacity: 0.4;
            background: #eef2ff;
            border: 2px dashed #6366f1;
        }
        
        .priority-badge-緊急 { background-color: #fef2f2; color: #b91c1c; }
        .priority-badge-高 { background-color: #fff7ed; color: #c2410c; }
        .priority-badge-中 { background-color: #eff6ff; color: #1d4ed8; }
        .priority-badge-低 { background-color: #f5f3ff; color: #6d28d9; }
        
        .sort-btn.sort-active { 
            background-color: white; 
            color: #4f46e5; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        
        .custom-input {
            background-color: #f0fdf4 !important;
            border-color: #a7f3d0 !important;
        }
        .custom-input:focus {
            --tw-ring-color: #34d399 !important;
            border-color: #10b981 !important;
        }
        
        .loading-spinner {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .task-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .task-card.expanded .task-details {
            max-height: 300px;
        }
        
        .expand-arrow {
            transition: transform 0.3s ease;
        }
        .task-card.expanded .expand-arrow {
            transform: rotate(180deg);
        }
        
        .department-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-待辦事項 { background-color: #f59e0b; }
        .status-進行中 { background-color: #3b82f6; }
        .status-已完成 { background-color: #10b981; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8 fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl mx-auto mb-4 flex items-center justify-center">
                    <i class="fas fa-tasks text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900 mb-2">工作任務追蹤平台</h1>
                <p class="text-slate-600">請選擇您的身份開始使用</p>
            </div>

            <!-- User List -->
            <div id="user-list" class="space-y-3 mb-6">
                <!-- 動態載入使用者列表 -->
            </div>

            <!-- Add User Button -->
            <button id="add-user-btn" type="button" class="w-full flex items-center justify-center px-4 py-3 text-sm font-semibold text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg transition border border-indigo-200 hover:border-indigo-300">
                <i class="fas fa-plus mr-2"></i>
                新增使用者
            </button>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 fade-in">
            <h2 class="text-xl font-semibold mb-6 text-slate-800">新增使用者</h2>
            
            <form id="add-user-form" class="space-y-4">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="new-user-name" class="block text-sm font-medium text-slate-700 mb-1">姓名</label>
                        <input type="text" id="new-user-name" name="name" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="請輸入姓名">
                    </div>
                    
                    <div>
                        <label for="new-user-department" class="block text-sm font-medium text-slate-700 mb-1">部門</label>
                        <select id="new-user-department" name="department" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="">請選擇部門</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="new-user-role" class="block text-sm font-medium text-slate-700 mb-1">角色</label>
                        <select id="new-user-role" name="role" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="user">一般使用者</option>
                            <option value="manager">管理者</option>
                            <option value="admin">系統管理員</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-add-user" class="px-4 py-2 text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 transition">取消</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">新增</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
            <!-- Header -->
            <header class="text-center mb-8">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 tracking-tight">工作任務追蹤平台</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-slate-600">您好，<span id="current-user-name" class="font-semibold text-indigo-600"></span></span>
                        <button id="logout-btn" class="text-sm font-medium text-slate-500 hover:text-indigo-600 transition p-2 rounded-md" title="登出">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- View Switcher -->
                <div class="flex justify-center items-center space-x-4 mb-6">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-slate-700">檢視模式:</label>
                        <select id="view-switcher" class="px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                            <option value="my">我的任務</option>
                            <option value="department">部門任務</option>
                            <option value="all">全部任務</option>
                        </select>
                    </div>
                    
                    <!-- Search and Sort Controls -->
                    <div class="flex items-center space-x-2">
                        <input type="text" id="search-input" placeholder="搜尋任務..." class="px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 w-48">
                        
                        <div class="flex items-center space-x-1 bg-slate-100 rounded-lg p-1">
                            <button id="sort-priority" class="sort-btn px-2 py-1 text-xs rounded transition sort-active" data-sort="priority">優先度</button>
                            <button id="sort-date" class="sort-btn px-2 py-1 text-xs rounded transition" data-sort="date">日期</button>
                            <button id="sort-title" class="sort-btn px-2 py-1 text-xs rounded transition" data-sort="title">標題</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Add Task Form -->
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-200 mb-8">
                <h2 class="text-xl font-semibold mb-6 text-slate-800 flex items-center">
                    <i class="fas fa-plus-circle mr-2 text-indigo-600"></i>
                    新增任務
                </h2>
                
                <form id="add-task-form" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="task-priority" class="block text-sm font-medium text-slate-600 mb-2">優先度</label>
                            <select id="task-priority" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="緊急">🔴 緊急</option>
                                <option value="高">🟡 高</option>
                                <option value="中" selected>🔵 中</option>
                                <option value="低">⚪ 低</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="task-assignee" class="block text-sm font-medium text-slate-600 mb-2">負責人</label>
                            <input type="text" id="task-assignee" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="請輸入負責人">
                        </div>
                        
                        <div>
                            <label for="task-due-date" class="block text-sm font-medium text-slate-600 mb-2">截止日期</label>
                            <input type="date" id="task-due-date" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <div>
                        <label for="task-department" class="block text-sm font-medium text-slate-600 mb-2">部門</label>
                        <select id="task-department" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">請選擇部門</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="task-title" class="block text-sm font-medium text-slate-600 mb-2">任務標題</label>
                        <input type="text" id="task-title" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="請輸入任務標題">
                    </div>
                    
                    <div>
                        <label for="task-description" class="block text-sm font-medium text-slate-600 mb-2">任務描述</label>
                        <textarea id="task-description" rows="3" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="請輸入任務描述（可選）"></textarea>
                    </div>
                    
                    <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        <i class="fas fa-plus mr-2"></i>
                        新增任務
                    </button>
                </form>
            </div>

            <!-- Department Tabs -->
            <div class="mb-6">
                <div class="border-b border-slate-200">
                    <nav id="department-tabs" class="-mb-px flex space-x-8 overflow-x-auto" aria-label="部門分頁">
                        <!-- 動態載入部門分頁 -->
                    </nav>
                </div>
            </div>

            <!-- Tasks Container -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Todo Column -->
                <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                    <div class="p-4 border-b border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 flex items-center">
                            <div class="w-3 h-3 bg-amber-500 rounded-full mr-2"></div>
                            待辦事項
                            <span id="todo-count" class="ml-2 text-sm bg-amber-100 text-amber-800 px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="todo-list" class="p-4 space-y-3 min-h-[300px]">
                        <!-- 動態載入待辦任務 -->
                    </div>
                </div>

                <!-- In Progress Column -->
                <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                    <div class="p-4 border-b border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 flex items-center">
                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                            進行中
                            <span id="progress-count" class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="progress-list" class="p-4 space-y-3 min-h-[300px]">
                        <!-- 動態載入進行中任務 -->
                    </div>
                </div>

                <!-- Done Column -->
                <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                    <div class="p-4 border-b border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                            已完成
                            <span id="done-count" class="ml-2 text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="done-list" class="p-4 space-y-3 min-h-[300px]">
                        <!-- 動態載入已完成任務 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="loading-spinner w-12 h-12 border-4 border-slate-200 border-t-indigo-600 rounded-full mb-4 mx-auto"></div>
            <p class="text-slate-600">載入中...</p>
        </div>
    </div>

    <script>
        // 工作任務追蹤平台 - 完整修復版
        class TaskManagerFixed {
            constructor() {
                this.currentUser = null;
                this.departments = [];
                this.users = [];
                this.tasks = [];
                this.currentDepartment = 'all';
                this.currentView = 'my';
                this.currentSort = 'priority';
                this.searchTerm = '';
                
                // 事件監聽器狀態
                this.eventListenersInitialized = false;
                
                this.init();
            }

            async init() {
                try {
                    console.log('🚀 TaskManager 初始化開始...');
                    await this.loadInitialData();
                    this.initializeEventListeners();
                    this.showAuthModal();
                    console.log('✅ TaskManager 初始化完成');
                } catch (error) {
                    console.error('❌ 初始化失敗:', error);
                    this.showError('系統初始化失敗，請重新整理頁面');
                }
            }

            // 載入初始資料（使用 localStorage 作為後備）
            async loadInitialData() {
                try {
                    console.log('📦 載入初始資料...');
                    
                    // 載入部門資料
                    this.departments = this.loadFromStorage('departments', [
                        { id: '1', name: '工程部', color: '#3b82f6', order_index: 1 },
                        { id: '2', name: '產品部', color: '#10b981', order_index: 2 },
                        { id: '3', name: '行銷部', color: '#f59e0b', order_index: 3 },
                        { id: '4', name: '設計部', color: '#8b5cf6', order_index: 4 },
                        { id: '5', name: '業務部', color: '#ef4444', order_index: 5 }
                    ]);

                    // 載入使用者資料
                    this.users = this.loadFromStorage('users', [
                        { id: '1', name: '張小明', department: '工程部', role: 'manager', avatar: null },
                        { id: '2', name: '李小華', department: '產品部', role: 'user', avatar: null },
                        { id: '3', name: '王小美', department: '行銷部', role: 'user', avatar: null }
                    ]);

                    // 載入任務資料
                    this.tasks = this.loadFromStorage('tasks', [
                        {
                            id: '1',
                            title: '完成使用者介面設計',
                            description: '設計新版本的使用者登入頁面',
                            department: '設計部',
                            assignee: '王小美',
                            priority: '高',
                            status: '待辦事項',
                            due_date: '2024-09-20',
                            created_at: new Date().toISOString()
                        },
                        {
                            id: '2',
                            title: '實作 API 接口',
                            description: '開發使用者管理相關的 REST API',
                            department: '工程部',
                            assignee: '張小明',
                            priority: '緊急',
                            status: '進行中',
                            due_date: '2024-09-18',
                            created_at: new Date().toISOString()
                        }
                    ]);

                    console.log('✅ 資料載入完成:', {
                        departments: this.departments.length,
                        users: this.users.length,
                        tasks: this.tasks.length
                    });

                    // 初始化部門選項
                    this.populateDepartmentSelects();

                } catch (error) {
                    console.error('載入資料失敗:', error);
                    throw error;
                }
            }

            // 從 localStorage 載入資料
            loadFromStorage(key, defaultValue) {
                try {
                    const data = localStorage.getItem(`taskManager_${key}`);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (error) {
                    console.warn(`載入 ${key} 失敗:`, error);
                    return defaultValue;
                }
            }

            // 儲存資料到 localStorage
            saveToStorage(key, data) {
                try {
                    localStorage.setItem(`taskManager_${key}`, JSON.stringify(data));
                } catch (error) {
                    console.error(`儲存 ${key} 失敗:`, error);
                }
            }

            // 填充部門選擇選項
            populateDepartmentSelects() {
                const selects = ['new-user-department', 'task-department'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        // 清空現有選項（保留第一個預設選項）
                        while (select.children.length > 1) {
                            select.removeChild(select.lastChild);
                        }
                        
                        // 添加部門選項
                        this.departments.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept.name;
                            option.textContent = dept.name;
                            select.appendChild(option);
                        });
                    }
                });
            }

            // 事件監聽器初始化 - 使用全域事件委派
            initializeEventListeners() {
                if (this.eventListenersInitialized) {
                    console.log('⚠️ 事件監聽器已初始化，跳過');
                    return;
                }

                console.log('🔧 初始化事件監聽器...');

                // 全域點擊事件委派
                document.addEventListener('click', (e) => this.handleGlobalClick(e));
                
                // 全域表單提交事件委派
                document.addEventListener('submit', (e) => this.handleGlobalSubmit(e));

                // 其他事件監聽器
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.searchTerm = e.target.value;
                        this.renderTasks();
                    });
                }

                const viewSwitcher = document.getElementById('view-switcher');
                if (viewSwitcher) {
                    viewSwitcher.addEventListener('change', (e) => {
                        this.currentView = e.target.value;
                        this.renderTasks();
                    });
                }

                // 鍵盤事件
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideAllModals();
                    }
                });

                this.eventListenersInitialized = true;
                console.log('✅ 事件監聽器初始化完成');
            }

            // 全域點擊事件處理
            handleGlobalClick(e) {
                const target = e.target;
                const id = target.id;

                // 處理不同按鈕點擊
                switch(id) {
                    case 'add-user-btn':
                        console.log('🎯 新增使用者按鈕點擊');
                        e.preventDefault();
                        this.showAddUserModal();
                        break;
                    
                    case 'cancel-add-user':
                        console.log('🎯 取消新增使用者');
                        e.preventDefault();
                        this.hideAddUserModal();
                        break;
                    
                    case 'logout-btn':
                        console.log('🎯 登出按鈕點擊');
                        this.logout();
                        break;
                    
                    default:
                        // 檢查使用者選擇按鈕
                        if (target.classList.contains('user-btn')) {
                            const userId = target.getAttribute('data-user-id');
                            this.selectUser(userId);
                        }
                        
                        // 檢查排序按鈕
                        if (target.classList.contains('sort-btn')) {
                            this.handleSortChange(target.getAttribute('data-sort'));
                        }
                        
                        // 檢查部門標籤
                        if (target.classList.contains('dept-tab')) {
                            this.handleDepartmentChange(target.getAttribute('data-dept'));
                        }
                        
                        // 檢查任務卡片
                        if (target.closest('.task-card')) {
                            this.handleTaskCardClick(target.closest('.task-card'));
                        }
                        break;
                }
            }

            // 全域表單提交事件處理
            handleGlobalSubmit(e) {
                const form = e.target;
                const id = form.id;
                
                console.log(`📋 表單提交: ${id}`);
                e.preventDefault();

                switch(id) {
                    case 'add-user-form':
                        this.handleAddUser(e);
                        break;
                    
                    case 'add-task-form':
                        this.handleAddTask(e);
                        break;
                    
                    default:
                        console.log('⚠️ 未處理的表單提交');
                        break;
                }
            }

            // 顯示認證模態框
            showAuthModal() {
                console.log('🔐 顯示認證模態框');
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    this.renderUserList();
                }
            }

            // 隱藏認證模態框
            hideAuthModal() {
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            }

            // 渲染使用者列表
            renderUserList() {
                console.log('👥 渲染使用者列表');
                const userList = document.getElementById('user-list');
                if (!userList) return;

                userList.innerHTML = this.users.map(user => `
                    <button class="user-btn w-full flex items-center p-4 text-left hover:bg-slate-50 rounded-lg border border-slate-200 hover:border-slate-300 transition" data-user-id="${user.id}">
                        <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold mr-3">
                            ${user.name.charAt(0)}
                        </div>
                        <div>
                            <div class="font-medium text-slate-800">${this.escapeHtml(user.name)}</div>
                            <div class="text-sm text-slate-600">${this.escapeHtml(user.department)} - ${this.getRoleName(user.role)}</div>
                        </div>
                    </button>
                `).join('');
            }

            // 獲取角色名稱
            getRoleName(role) {
                const roleNames = {
                    'user': '一般使用者',
                    'manager': '管理者',
                    'admin': '系統管理員'
                };
                return roleNames[role] || '一般使用者';
            }

            // 選擇使用者
            selectUser(userId) {
                console.log('👤 選擇使用者:', userId);
                const user = this.users.find(u => u.id === userId);
                if (user) {
                    this.currentUser = user;
                    this.hideAuthModal();
                    this.showMainApp();
                }
            }

            // 顯示主應用
            showMainApp() {
                console.log('📱 顯示主應用');
                const appContainer = document.getElementById('app-container');
                if (appContainer) {
                    appContainer.classList.remove('hidden');
                    
                    // 更新使用者名稱顯示
                    const userNameElement = document.getElementById('current-user-name');
                    if (userNameElement && this.currentUser) {
                        userNameElement.textContent = this.currentUser.name;
                    }
                    
                    // 渲染部門標籤和任務
                    this.renderDepartmentTabs();
                    this.renderTasks();
                }
            }

            // 顯示新增使用者模態框
            showAddUserModal() {
                console.log('📱 顯示新增使用者模態框');
                const modal = document.getElementById('add-user-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    // 聚焦到姓名欄位
                    setTimeout(() => {
                        const nameInput = document.getElementById('new-user-name');
                        if (nameInput) {
                            nameInput.focus();
                        }
                    }, 100);
                }
            }

            // 隱藏新增使用者模態框
            hideAddUserModal() {
                const modal = document.getElementById('add-user-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    
                    // 重置表單
                    const form = document.getElementById('add-user-form');
                    if (form) {
                        form.reset();
                    }
                }
            }

            // 處理新增使用者
            handleAddUser(e) {
                console.log('👤 處理新增使用者');
                const formData = new FormData(e.target);
                const userData = {
                    id: Date.now().toString(),
                    name: formData.get('name').trim(),
                    department: formData.get('department'),
                    role: formData.get('role'),
                    avatar: null,
                    created_at: new Date().toISOString()
                };

                // 驗證資料
                if (!userData.name || !userData.department) {
                    this.showError('請填寫所有必要欄位');
                    return;
                }

                // 檢查重複使用者
                if (this.users.find(u => u.name === userData.name)) {
                    this.showError('該使用者名稱已存在');
                    return;
                }

                // 新增使用者
                this.users.push(userData);
                this.saveToStorage('users', this.users);
                
                console.log('✅ 使用者新增成功:', userData);
                
                // 更新 UI
                this.renderUserList();
                this.hideAddUserModal();
                this.showSuccess(`使用者 "${userData.name}" 新增成功`);
            }

            // 處理新增任務
            handleAddTask(e) {
                console.log('📋 處理新增任務');
                const formData = new FormData(e.target);
                const taskData = {
                    id: Date.now().toString(),
                    title: formData.get('title') || document.getElementById('task-title').value,
                    description: formData.get('description') || document.getElementById('task-description').value,
                    department: document.getElementById('task-department').value,
                    assignee: document.getElementById('task-assignee').value,
                    priority: document.getElementById('task-priority').value,
                    due_date: document.getElementById('task-due-date').value,
                    status: '待辦事項',
                    created_at: new Date().toISOString(),
                    creator_id: this.currentUser?.id
                };

                // 驗證必要欄位
                if (!taskData.title || !taskData.department) {
                    this.showError('請填寫任務標題和部門');
                    return;
                }

                // 新增任務
                this.tasks.push(taskData);
                this.saveToStorage('tasks', this.tasks);
                
                console.log('✅ 任務新增成功:', taskData);
                
                // 重置表單
                e.target.reset();
                
                // 更新 UI
                this.renderTasks();
                this.showSuccess(`任務 "${taskData.title}" 新增成功`);
            }

            // 渲染部門標籤
            renderDepartmentTabs() {
                const tabsContainer = document.getElementById('department-tabs');
                if (!tabsContainer) return;

                const allTab = `
                    <button class="dept-tab px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 border-b-2 border-transparent hover:border-slate-300 transition ${this.currentDepartment === 'all' ? 'tab-active' : ''}" data-dept="all">
                        全部部門
                    </button>
                `;

                const deptTabs = this.departments.map(dept => `
                    <button class="dept-tab px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 border-b-2 border-transparent hover:border-slate-300 transition ${this.currentDepartment === dept.name ? 'tab-active' : ''}" data-dept="${dept.name}">
                        <span class="department-color" style="background-color: ${dept.color};"></span>
                        ${dept.name}
                    </button>
                `).join('');

                tabsContainer.innerHTML = allTab + deptTabs;
            }

            // 處理部門切換
            handleDepartmentChange(department) {
                console.log('🏢 切換部門:', department);
                this.currentDepartment = department;
                this.renderDepartmentTabs();
                this.renderTasks();
            }

            // 處理排序切換
            handleSortChange(sortType) {
                console.log('🔄 切換排序:', sortType);
                this.currentSort = sortType;
                
                // 更新排序按鈕狀態
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    btn.classList.remove('sort-active');
                });
                document.getElementById(`sort-${sortType}`).classList.add('sort-active');
                
                this.renderTasks();
            }

            // 渲染任務
            renderTasks() {
                console.log('📋 渲染任務');
                
                // 獲取篩選後的任務
                let filteredTasks = this.getFilteredTasks();
                
                // 排序任務
                filteredTasks = this.sortTasks(filteredTasks);
                
                // 按狀態分組
                const tasksByStatus = {
                    '待辦事項': filteredTasks.filter(task => task.status === '待辦事項'),
                    '進行中': filteredTasks.filter(task => task.status === '進行中'),
                    '已完成': filteredTasks.filter(task => task.status === '已完成')
                };

                // 渲染各狀態的任務
                this.renderTaskList('todo-list', tasksByStatus['待辦事項']);
                this.renderTaskList('progress-list', tasksByStatus['進行中']);
                this.renderTaskList('done-list', tasksByStatus['已完成']);

                // 更新計數
                document.getElementById('todo-count').textContent = tasksByStatus['待辦事項'].length;
                document.getElementById('progress-count').textContent = tasksByStatus['進行中'].length;
                document.getElementById('done-count').textContent = tasksByStatus['已完成'].length;
            }

            // 獲取篩選後的任務
            getFilteredTasks() {
                return this.tasks.filter(task => {
                    // 部門篩選
                    const departmentMatch = this.currentDepartment === 'all' || task.department === this.currentDepartment;
                    
                    // 檢視篩選
                    let viewMatch = true;
                    if (this.currentView === 'my' && this.currentUser) {
                        viewMatch = task.assignee === this.currentUser.name || task.creator_id === this.currentUser.id;
                    } else if (this.currentView === 'department' && this.currentUser) {
                        viewMatch = task.department === this.currentUser.department;
                    }
                    
                    // 搜尋篩選
                    const searchMatch = !this.searchTerm || 
                        task.title.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                        task.description.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                        task.assignee.toLowerCase().includes(this.searchTerm.toLowerCase());
                    
                    return departmentMatch && viewMatch && searchMatch;
                });
            }

            // 排序任務
            sortTasks(tasks) {
                return tasks.sort((a, b) => {
                    switch (this.currentSort) {
                        case 'priority':
                            const priorityOrder = { '緊急': 4, '高': 3, '中': 2, '低': 1 };
                            return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
                        case 'date':
                            return new Date(b.created_at) - new Date(a.created_at);
                        case 'title':
                            return a.title.localeCompare(b.title);
                        default:
                            return 0;
                    }
                });
            }

            // 渲染任務列表
            renderTaskList(containerId, tasks) {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (tasks.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-8">暫無任務</div>';
                    return;
                }

                container.innerHTML = tasks.map(task => this.createTaskCard(task)).join('');
            }

            // 創建任務卡片
            createTaskCard(task) {
                const priorityEmoji = {
                    '緊急': '🔴',
                    '高': '🟡',
                    '中': '🔵',
                    '低': '⚪'
                };

                const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString('zh-TW') : '';
                const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== '已完成';

                return `
                    <div class="task-card bg-white border border-slate-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer" data-task-id="${task.id}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${priorityEmoji[task.priority]}</span>
                                <span class="priority-badge-${task.priority} text-xs px-2 py-1 rounded-full font-medium">${task.priority}</span>
                                ${isOverdue ? '<span class="text-red-500 text-xs">⚠️ 逾期</span>' : ''}
                            </div>
                            <button class="text-slate-400 hover:text-slate-600 expand-arrow">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <h4 class="font-semibold text-slate-800 mb-1">${this.escapeHtml(task.title)}</h4>
                        <p class="text-sm text-slate-600 mb-2">${this.escapeHtml(task.description || '')}</p>
                        
                        <div class="task-details">
                            <div class="text-xs text-slate-500 space-y-1 pt-2 border-t border-slate-100">
                                <div><strong>部門:</strong> ${this.escapeHtml(task.department)}</div>
                                <div><strong>負責人:</strong> ${this.escapeHtml(task.assignee || '未分配')}</div>
                                ${dueDate ? `<div><strong>截止日期:</strong> ${dueDate}</div>` : ''}
                                <div><strong>建立時間:</strong> ${new Date(task.created_at).toLocaleDateString('zh-TW')}</div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs text-slate-500">${this.escapeHtml(task.department)}</span>
                            <div class="flex space-x-2">
                                <button class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition" onclick="taskManager.changeTaskStatus('${task.id}', '待辦事項')">待辦</button>
                                <button class="text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 transition" onclick="taskManager.changeTaskStatus('${task.id}', '進行中')">進行中</button>
                                <button class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition" onclick="taskManager.changeTaskStatus('${task.id}', '已完成')">完成</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 處理任務卡片點擊
            handleTaskCardClick(card) {
                card.classList.toggle('expanded');
            }

            // 更改任務狀態
            changeTaskStatus(taskId, newStatus) {
                console.log('🔄 更改任務狀態:', taskId, newStatus);
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = newStatus;
                    if (newStatus === '已完成') {
                        task.completed_at = new Date().toISOString();
                    }
                    this.saveToStorage('tasks', this.tasks);
                    this.renderTasks();
                    this.showSuccess(`任務狀態已更新為 "${newStatus}"`);
                }
            }

            // 登出
            logout() {
                console.log('🚪 使用者登出');
                this.currentUser = null;
                document.getElementById('app-container').classList.add('hidden');
                this.showAuthModal();
            }

            // 隱藏所有模態框
            hideAllModals() {
                const modals = ['add-user-modal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal && !modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                    }
                });
            }

            // 工具函數
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showError(message) {
                console.error('❌ 錯誤:', message);
                alert(message); // 簡單的錯誤顯示，可以後續改為更好的 UI
            }

            showSuccess(message) {
                console.log('✅ 成功:', message);
                // 可以添加更好的成功提示 UI
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 3000);
            }
        }

        // 初始化應用程式
        let taskManager;

        // DOM 載入完成後初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM 載入完成，初始化任務管理器');
            taskManager = new TaskManagerFixed();
        });

        // 備用初始化
        window.addEventListener('load', () => {
            if (!taskManager) {
                console.log('🔄 使用備用初始化');
                taskManager = new TaskManagerFixed();
            }
        });

        // 全域錯誤處理
        window.addEventListener('error', (e) => {
            console.error('💥 全域錯誤:', e.error);
        });
    </script>
</body>
</html>
